
# 동작과정 

![image](https://user-images.githubusercontent.com/78713176/224259304-c4fdb08c-54b2-49a1-9d56-c959bce29a26.png)


## 1. DHCP Discover(클라이언트 → 릴레이 에이전트)

DHCP 클라이언트는 DHCP 서버를 찾기 위해 브로드캐스트로 패킷을 전송한다.

## 2. DHCP Discover(릴레이 에이전트 → DHCP 서버)

DHCP 릴레이 에이전트는 클라이언트가 보낸 DHCP Discover 메시지를 다른 네트워크에 있는 DHCP 서버로 전달하기 위해 출발지와 목적지를 릴레이 에이전트 IP 주소와 DHCP 서버 IP 주소로 재작성한다.

> 즉, 릴레이 에이전트는 브로드캐스트를 받았으면 이를 DHCP 서버로 중계(전달)시키는 역할을 한다.

목적지가 브로드캐스트에서 DHCP 서버 IP 주소로 변경되었기 때문에 릴레이 에이전트가 DHCP 서버로 DHCP Discover 메시지를 보낼 때는 **유니캐스트**가 된다. 

> 이를 통해, 서로 다른 대역의 네트워크가 브로드캐스트가 아니었던 것으로 바뀜으로써 통신이 가능하게 된다.

DHCP 메시지의 릴레이 에이전트 IP 항목에는 릴레이 에이전트 IP 주소를 포함한다. 이때 출발지 주소와 DHCP 메시지에 사용되는 릴레이 에이전트 IP 주소는 같지 않다.  

출발지 주소로 사용되는 IP 주소는 DHCP 서버로 가기 위한 방향의 인터페이스 IP 주소이며 DHCP 메시지에 사용되는 릴레이 에이전트 IP 주소는 DHCP 클라이언트가 속한 내부 인터페이스의 IP 주소입니다.

## 3. DHCP Offer(DHCP 서버 → 릴레이 에이전트)

DHCP Discover를 수신한 DHCP 서버는 **클라이언트에 할당할 IP 주소와 서브넷, 게이트웨이, DNS 정보, 임대 시간(Lease Time) 등의 정보를 포함한 DHCP 메시지**를 DHCP 릴레이 에이전트로 다시 전송한다. 이때 DHCP Server Identifier는 DHCP 서버 자신이 된다. 

DHCP 서버에서 DHCP 릴레이 에이전트의 전송은 DHCP Discover 수신과 같은 **유니캐스트**다.

## 4. DHCP Offer(릴레이 에이전트 → 클라이언트)

DHCP 릴레이 에이전트는 DHCP Offer 메시지를 DHCP 클라이언트에 **브로드캐스트**로 다시 전송하는데 DHCP 메시지 내의 다른 값은 모두 동일하게 전송되지만 DHCP Server Identifier는 실제 DHCP 서버의 IP 주소에서 릴레이 에이전트의 외부 인터페이스 IP 주소로 변경하여 전송한다.

## 5. DHCP Request(클라이언트 → 릴레이 에이전트)

DHCP 클라이언트는 DHCP 서버로부터 제안받은 IP 주소(Requested IP)와 DHCP 서버 정보(DHCP Server Identifier)를 포함한 DHCP 요청 메시지를 **브로드캐스트**로 전송한다.

## 6. DHCP Request(릴레이 에이전트 → DHCP 서버)

DHCP 클라이언트에서 보낸 DHCP 요청 메시지를 **유니캐스트로 다시 변환**해 DHCP 서버로 전달한다.

## 7. DHCP ACK(DHCP 서버 → 릴레이 에이전트)

DHCP 요청을 받은 DHCP 서버는 **해당 IP를 어떤 클라이언트가 언제부터 사용하기 시작했는지 정보를 기록하고 DHCP Request 메시지를 정상적으로 수신했다는 응답을 전송**한다. 마찬가지로 **유니캐스트** 형태로 전송한다.

## 8. DHCP ACK(릴레이 에이전트 → 클라이언트)

DHCP 서버에서 받은 Ack 메시지를 클라이언트에 **브로드캐스트**로 다시 전달한다.

DHCP 릴레이 에이전트를 사용한 과정을 보면 DHCP를 통해 IP를 받으려는 클라이언트는 **릴레이 에이전트를 통해 IP를 할당받는 것인지 알 수 없어 DHCP 릴레이 에이전트를 사용하지 않았던 기본 동작 방식 과정과 다르지 않다.** 이처럼 DHCP 릴레이 에이전트가 직접 통신이 불가능한 DHCP 클라이언트와 DHCP 서버 간 통신을 위한 중간자 역할을 위해 대신 수행하게 된다.

이때 DHCP 클라이언트와 DHCP 릴레이 에이전트 간에는 브로드캐스트로 동작하고 다시 DHCP 릴레이 에이전트와 DHCP 서버 간에는 **유니캐스트**로 동작하게 된다. 

이것을 위해 **DHCP 릴레이 에이전트는 DHCP 클라이언트와 같은 L2 네트워크 내에 존재**해야 하며 **DHCP 서버에는 유니캐스트로 전달하기 위해 DHCP 서버의 IP 주소가 등록**되어 있어야 한다.